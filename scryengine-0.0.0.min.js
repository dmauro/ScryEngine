/*
  Scry Engine version 0.0.0 (c) 2014 David Mauro.
  Licensed under the Apache License, Version 2.0
  http://www.apache.org/licenses/LICENSE-2.0
*/
(function(){var ca,e,ra,Ba,k={}.hasOwnProperty,R=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},v=[].slice,l=function(a,b){function c(){this.constructor=a}for(var d in b)k.call(b,d)&&(a[d]=b[d]);c.prototype=b.prototype;a.prototype=new c;a.__super__=b.prototype;return a};e={actions:{},utils:{},events:{actions:{}},geography:{zones:{},tiles:{}},sentience:{},things:{},ui:{components:{data_sources:{}}},maps:{},perception:{},random:{}};e.utils.multiply_hex_number=
function(a,b){var c,d,f;f=parseInt(a.substr(0,2),16);d=parseInt(a.substr(2,2),16);c=parseInt(a.substr(4,2),16);f=Math.round(f*b);f=f.toString(16);for(2<f.length&&(f="ff");2>f.length;)f="0"+f;d=Math.round(d*b);d=d.toString(16);for(2<d.length&&(d="ff");2>d.length;)d="0"+d;c=Math.round(c*b);c=c.toString(16);for(2<c.length&&(c="ff");2>c.length;)c="0"+c;return""+f+d+c};e.utils.add_hex_numbers=function(a,b){return(parseInt(a,16)+parseInt(b,16)).toString(16)};e.utils.add_hex_colors=function(a,b){var c,d,
f;f=e.utils.add_hex_numbers(a.substr(0,2),b.substr(0,2));for(2<f.length&&(f="ff");2>f.length;)f="0"+f;d=e.utils.add_hex_numbers(a.substr(2,2),b.substr(2,2));for(2<d.length&&(d="ff");2>d.length;)d="0"+d;c=e.utils.add_hex_numbers(a.substr(4,2),b.substr(4,2));for(2<c.length&&(c="ff");2>c.length;)c="0"+c;return""+f+d+c};e.utils.deep_extend=function(a){var b,c,d,f,g;f=0;for(g=arguments.length;f<g;f++)if(b=arguments[f],b!==a)for(c in b)k.call(b,c)&&(d=b[c],"object"===typeof d?(a[c]=a[c]||{},e.utils.deep_extend(a[c],
d)):a[c]=d);return a};e.utils.constructor_from_string=function(a){var b,a=a.split(".");b=e;for(a.shift();a.length;)b=b[a.shift()];return b};e.utils.generate_uuid=function(a){var b,c,d,f;d="";for(b=f=0;32>f;b=++f){c=16*a()|0;if(8===b||12===b||16===b||20===b)d+="-";d+=(12===b?4:16===b?c&3||8:c).toString(16)}return d};e.utils.combine_arrays=function(){var a,b,c,d,f,e,h;b=[];d=0;for(e=arguments.length;d<e;d++){a=arguments[d];f=0;for(h=a.length;f<h;f++)c=a[f],b.push(c)}return b};e.utils.compare_arrays=
function(a,b){var c,d,f;if(a.length!==b.length)return!1;d=0;for(f=a.length;d<f;d++)if(c=a[d],!(0<=R.call(b,c)))return!1;d=0;for(f=b.length;d<f;d++)if(c=b[d],!(0<=R.call(a,c)))return!1;return!0};e.utils.remove_val_from_array=function(a,b){var c;if(!(a&&null!=b))return!1;if(-1<(c=a.indexOf(b)))[].splice.apply(a,[c,c-c+1].concat(c=[])),c;return a};e.utils.subtract_arrays=function(a,b){var c,d,f,g;c=[];f=0;for(g=a.length;f<g;f++)d=a[f],c.push(d);f=0;for(g=b.length;f<g;f++)d=b[f],e.utils.remove_val_from_array(c,
d);return c};e.utils.array_from_dict_keys=function(a){var b,c;b=[];for(c in a)b.push(c);return b};e.utils.roll=function(a,b){var c,d,f,e,h;null==a&&(a="1d20");null==b&&(b=!1);c=parseInt(a.slice(0,a.indexOf("d")),10);f=parseInt(a.slice(a.indexOf("d")+1),10);d=[];e=0;for(c-=1;0<=c?e<=c:e>=c;0<=c?++e:--e)d.push(Math.floor(game.random()*f)+1);if(b)return d;c=f=0;for(h=d.length;c<h;c++)e=d[c],f+=e;return f};e.utils.hex_to_rgb=function(a){var b,c,d,f;if(3!==(f=a.length)&&6!==f)a=a.substr(1);3===a.length?
(d=parseInt(a.substr(0,1)+a.substr(0,1),16),c=parseInt(a.substr(1,1)+a.substr(1,1),16),b=parseInt(a.substr(2,1)+a.substr(2,1),16)):6===a.length&&(d=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16),b=parseInt(a.substr(4,2),16));return[d,c,b]};e.utils.get_direction_between_points=function(a,b){var c,d;c=b[0]-a[0];d=b[1]-a[1];if(0<c){if(0<d)return"SE";if(0>d)return"NE";if(0===d)return"E"}if(0>c){if(0<d)return"SW";if(0>d)return"NW";if(0===d)return"W"}if(0===c){if(0<d)return"S";if(0>d)return"N"}return!1};
e.utils.tiles_are_touching=function(a,b){if(1>=Math.abs(a.x-b.x)&&a.y===b.y||1>=Math.abs(a.y-b.y)&&a.x===b.x)return!0};e.utils.get_tiles_between=function(a,b,c){var d,f,g,h,i,m,n,t,s,x,k,G,l,j,o;null==c&&(c=!1);i=game.current_map;G=s=a.x;j=x=a.y;l=b.x;b=b.y;c?(t=a.is_impassable,d=Math.atan2(b-j,l-G)/Math.PI):k=[];a=Math.abs(l-G);f=Math.abs(b-j);m=G<l?1:-1;n=j<b?1:-1;for(h=a-f;!(G===l&&j===b);)if(g=h<<1,g>-f&&(h-=f,G+=m),g<a&&(h+=a,j+=n),g=i.get_tile_at(G,j),c){if(c&&g.is_impassable){if(t&&e.utils.tiles_are_adjacent({x:s,
y:x},{x:G,y:j}))if(g=G-s,o=j-x,1===g&&0===o){if(-0.5<d&&0>d&&!i.get_tile_at(s+1,x-1).is_impassable)continue;if(0<d&&0.5>d&&!i.get_tile_at(s+1,x+1).is_impassable)continue}else if(-1===g&&0===o){if(-1<d&&-0.5>d&&!i.get_tile_at(s-1,x-1).is_impassable)continue;if(0.5<d&&1>d&&!i.get_tile_at(s-1,x+1).is_impassable)continue}else if(0===g&&1===o){if(0<d&&0.5>d&&!i.get_tile_at(s+1,x+1).is_impassable)continue;if(0.5<d&&1>d&&!i.get_tile_at(s-1,x+1).is_impassable)continue}else if(0===g&&-1===o){if(-0.5<d&&0>
d&&!i.get_tile_at(s+1,x-1).is_impassable)continue;if(-1<d&&-0.5>d&&!i.get_tile_at(s-1,x-1).is_impassable)continue}return!1}}else k.push(g);return c?!0:k};e.utils.has_los=function(a,b){return e.utils.get_tiles_between(a,b,!0)?!0:!1};e.utils.get_tiles_within_radius=function(a,b,c){var d,f,g,h,i,m,n,t,s,x,j,k,l,o,q,p;f=game.current_map;m=a[0];t=a[1];h=[];g=b+0.25;n=s=j=t-b;for(k=t+b;j<=k?s<=k:s>=k;n=j<=k?++s:--s){i=x=l=m-b;for(o=m+b;l<=o?x<=o:x>=o;i=l<=o?++x:--x)if(d=e.utils.get_distance_between_points(a,
[i,n]),!(d>g)&&(d=f.get_tile_at(i,n))&&!("empty"===(q=d.type)||"solid"===q))if(i===m&&n===t)h.push(d);else if(d&&!("empty"===(p=d.type)||"solid"===p))(!c||e.utils.has_los(d,{x:m,y:t}))&&h.push(d)}return h};e.utils.get_distance_between_points=function(a,b){return Math.sqrt((a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1]))};e.utils.get_distance_between_in_feet=function(){var a;return 5*(a=e.utils).get_distance_between.apply(a,arguments)};e.utils.get_distance_between=function(a,b){var c,d,f,g,h,i,m,n,
t,s;d=a.width;c=a.height;i=b.width;h=b.height;f=a.x;g=a.y;m=b.x;n=b.y;if(d||c||i||h)t=f-m,s=g-n,0<t&&i?m+=i-1:0>t&&d&&(f+=d-1),0<s&&h?n+=h-1:0>s&&c&&(g+=c-1);return e.utils.get_distance_between_points([f,g],[m,n])};e.utils.tiles_are_adjacent=function(a,b){if(1>=Math.abs(a.x-b.x)&&1>=Math.abs(a.y-b.y))return!0};e.utils.sprites_are_adjacent=function(a,b,c,d){var f,g;null==c&&(c=null);null==d&&(d=null);c=c||a.width||1;d=d||a.height||1;g=b.width;f=b.height;return 1<c||1<d||g||f?2>e.utils.get_distance_between({x:a.x,
y:a.y,width:c,height:d},{x:b.x,y:b.y,width:g,height:f}):e.utils.tiles_are_adjacent(a,b)};e.utils.sprite_can_fit_tile=function(a,b){var c,d;d=a.width;c=a.height;return!d&&!c?!0:e.utils.size_can_fit(d,c,b.x,b.y)};e.utils.size_can_fit=function(a,b,c,d){var f,e,h,i,m,n,t;h=game.current_map;e=!0;i=m=d;for(n=d+b;d<=n?m<n:m>n;i=d<=n?++m:--m){f=b=c;for(t=c+a;c<=t?b<t:b>t;f=c<=t?++b:--b)if(f=h.get_tile_at(f,i),f.is_impassable){e=!1;break}}return e};e.utils.get_path_between=function(a,b,c,d,f){null==c&&(c=
1);null==d&&(d=1);null==f&&(f=0);return 1<c||1<d?pathfinding.get_astar_path.apply(pathfinding,arguments):pathfinding.get_jps_path.apply(pathfinding,arguments)};var Ja=e.utils,H=function(a){var b,c,d,f;for(c in a)if(k.call(a,c))for(d in f=a[c],this[c]={},f)k.call(f,d)&&(b=f[d],this[c][d]=b)};H.prototype.__defineGetter__("length",function(){var a,b,c,d;a=0;for(b in this)if(k.call(this,b))for(c in d=this[b],d)k.call(d,c)&&(a+=1);return a});H.prototype.__defineGetter__("width",function(){var a,b,c;a=
Infinity;b=-Infinity;for(c in this)k.call(this,c)&&(c=parseInt(c,10),c<a&&(a=c),c>b&&(b=c));a=Math.abs(b-a);return-Infinity===a?0:a});H.prototype.__defineGetter__("height",function(){var a,b,c,d,f;b=Infinity;a=-Infinity;for(c in this)if(k.call(this,c))for(d in f=this[c],f)k.call(f,d)&&(d=parseInt(d,10),d<b&&(b=d),d>a&&(a=d));a=Math.abs(a-b);return-Infinity===a?0:a});H.prototype.for_each=function(a){var b,c,d,f;for(c in this)if(k.call(this,c))for(d in f=this[c],f)k.call(f,d)&&(b=f[d],a(b,1*c,1*d))};
H.prototype.set_value_at=function(a,b,c){null==this[a]&&(this[a]={});return this[a][b]=c};H.prototype.get_value_at=function(a,b){var c;return null!=(c=this[a])?c[b]:void 0};H.prototype.remove_value_at=function(a,b){var c,d;delete this[a][b];c=0;d=this[a];for(b in d)if(k.call(d,b)){c+=1;break}if(!c)return delete this[a]};H.prototype.get_save_data=function(a){var b,c,d,f,e;b={};for(d in this)if(k.call(this,d))for(f in e=this[d],b[d]={},e)k.call(e,f)&&(c=e[f],b[d][f]="function"===typeof a?a(c,d,f):c);
return b};Ja.MatrixArray=H;var Ka=e.utils,ia=function(a){var b,c,d,f;for(b in a)if(k.call(a,b))for(c in d=a[b],this[b]={},d)k.call(d,c)&&(f=d[c],this[b][c]=f)};ia.prototype.get_value_for_keys=function(a,b){var c,d,f;c=null!=(d=this[a])?d[b]:void 0;null==c&&(c=null!=(f=this[b])?f[a]:void 0);return c};ia.prototype.set_value_for_keys=function(a,b,c){var d;if(null!=(null!=(d=this[a])?d[b]:void 0))return this[a][b]=c;if("function"===typeof this[b]&&this[b](null!=this[a]))return this[b][a]=c;if(null!=this[a])return this[a][b]=
c;if(null!=this[b])return this[b][a]=c;this[a]={};return this[a][b]=c};ia.prototype.get_save_data=function(){var a,b,c,d,f;d={};for(a in this)if(k.call(this,a))for(b in c=this[a],d[a]={},c)k.call(c,b)&&(f=c[b],d[a][b]=f);return d};Ka.RelationshipDictionary=ia;var La=e.random,Ca=function(){this.n=4022871197};Ca.prototype.mash=function(a){var b,c,d,a=a.toString();b=c=0;for(d=a.length-1;0<=d?c<=d:c>=d;b=0<=d?++c:--c)this.n+=a.charCodeAt(b),b=0.02519603282416938*this.n,this.n=b>>>0,b-=this.n,b*=this.n,
this.n=b>>>0,b-=this.n,this.n+=4294967296*b;return 2.3283064365386963E-10*(this.n>>>0)};La.Mash=Ca;var Ma=e.random,I=function(a,b){null!=a?this._restore(a):this._init(b)};I.prototype._init=function(a){var b,c,d,f,g;this.seeds=a||[+new Date];this.c=1;a=new e.random.Mash;this.s0=a.mash(" ");this.s1=a.mash(" ");this.s2=a.mash(" ");f=this.seeds;g=[];c=0;for(d=f.length;c<d;c++)b=f[c],this.s0-=a.mash(b),0>this.s0&&(this.s0+=1),this.s1-=a.mash(b),0>this.s1&&(this.s1+=1),this.s2-=a.mash(b),0>this.s2?g.push(this.s2+=
1):g.push(void 0);return g};I.prototype._restore=function(a){"string"===typeof a&&(a=JSON.parse(a));this.seeds=a.seeds;this.c=a.c;this.s0=a.s0;this.s1=a.s1;return this.s2=a.s2};I.prototype.random=function(){var a;a=2091639*this.s0+2.3283064365386963E-10*this.c;this.s0=this.s1;this.s1=this.s2;return this.s2=a-(this.c=a|0)};I.prototype.range=function(a,b){return Math.round(this.random()*(b-a)+a)};I.prototype.choice=function(a){return a[this.range(0,a.length-1)]};I.prototype.uint32=function(){return 4294967296*
this.random()};I.prototype.fract53=function(){return this.random()+1.1102230246251565E-16*(2097152*this.random()|0)};I.prototype.get_save_data=function(){return this};Ma.Alea=I;var J=function(a){this.config=a};J.prototype.start=function(){this.user=new e.User;return this.show_main_menu()};J.prototype.show_main_menu=function(){var a;a=new e.ui.components.Menu;var b=this,c=this;a.data_source=new e.ui.components.data_sources.MenuDataSource([{text:"New Game",selection_callback:function(){return a.dismiss(function(){return b.start_new_game()})}},
{text:"Continue Game",selection_callback:function(){return a.dismiss(function(){var a;a=(a=localStorage.getItem("quicksave"))||localStorage.getItem("fullsave");return c.continue_game(a)})}}]);return a.show()};J.prototype._save_game_data_locally=function(a){a=JSON.stringify(a);localStorage.setItem("fullsave",a);return localStorage.removeItem("quicksave")};J.prototype._save_game_data_remotely=function(a,b){JSON.stringify(a);if("function"===typeof b)return b()};J.prototype._create_from_constructor_string=
function(){var a,b;b=arguments[0];a=2<=arguments.length?v.call(arguments,1):[];b=e.utils.constructor_from_string(b);var c=function(){};c.prototype=b.prototype;c=new c;b=b.apply(c,a);return Object(b)===b?b:c};J.prototype.create_game=function(a){this.game=this._create_from_constructor_string(this.config.game_class,this.config,a);this.game.quicksave_handler=function(a){a=JSON.stringify(a);return localStorage.setItem("quicksave",a)};var b=this;this.game.fullsave_handler=function(a){b._save_game_data_locally(a);
return b._save_game_data_remotely(a)};var c=this;return this.game.exit_handler=function(){c.game.fullsave();c.game=null;return c.show_main_menu()}};J.prototype.start_new_game=function(){var a;a=this._create_from_constructor_string(this.config.chargen_class,e.utils.constructor_from_string(this.config.base_player_thing_class));var b=this;a.on_complete_callback=function(a){b.create_game();b.game.set_protagonist(a);return b.game.start()};return a.start()};J.prototype.continue_game=function(a){this.create_game(a);
return this.game.start()};e.Application=J;var Na=e.actions,Da=function(a){this.world=a};Da.prototype.do_action=function(a,b,c,d,f){if(null==b)return f("Action does not exist.");a instanceof e.things.Player&&this.stop_listening_for_actions();return(new b(a.get_host(),c,this.world,d,f))["do"]()};Na.ActionManager=Da;var Oa=e.actions,sa=function(a,b,c,d,f){this.actor=a;this.data=b;this.world=c;this.success_callback=d;this.failure_callback=f;this.registry=this.actor.registry;this.time=0};sa.prototype._get_time_to_complete=
function(){return this.time};sa.prototype["do"]=function(){if("function"===typeof this.success_callback)return this.success_callback(this._get_time_to_complete())};Oa.Base=sa;var Pa=e.actions,O=function(){return O.__super__.constructor.apply(this,arguments)};l(O,e.actions.Base);O.prototype._tile_is_impassable=function(){return!this.actor.incorporeal?(this.failure_callback("You cannot enter that tile"),!0):!1};O.prototype._tile_is_obstacle=function(){return!this.actor.is_flying?(this.failure_callback("You cannot enter that tile"),
!0):!1};O.prototype._thing_is_in_target_location=function(){return this.failure_callback("Something is already on that tile")};O.prototype["do"]=function(){var a,b,c,d,f,e;b=this.actor.x+this.data.x;c=this.actor.y+this.data.y;a=this.world.get_tile_at(b,c);if(!(a.is_impassable&&this._tile_is_impassable()||a.is_obstacle&&this._tile_is_obstacle())){d=this.registry.get_things_with_position(b,c);f=0;for(e=d.length;f<e;f++)if(a=d[f],this._thing_is_in_target_location(a))return;this.actor.move_to(b,c);return O.__super__["do"].call(this)}};
Pa.Move=O;var Qa=e.actions,S=function(){return S.__super__.constructor.apply(this,arguments)};l(S,e.actions.Move);S.prototype._fail_if_movement_is_invalid=function(a,b){if(0===a&&0===b)return this.failure_callback("You cannot move to the same position you are currently on.");if(!a&&!b||!(-1<=a&&1>=a)||!(-1<=b&&1>=b))return this.failure_callback("You must move to an adjacent location")};S.prototype._get_time_to_complete=function(){return this.time*(this.actor.speed||1)};S.prototype["do"]=function(){var a,
b;a=Math.abs(this.data.x);b=Math.abs(this.data.y);this._fail_if_movement_is_invalid(a,b);this.time=1===a&&1!==b||1!==a&&1===b?1:1.4;var c=this;return setTimeout(function(){return S.__super__["do"].call(c)},100)};Qa.Walk=S;var Ra=e.events,ta=function(a,b,c){var d;this.name=a;null==b&&(b={});this.parent_event=c;for(d in b)if(k.call(b,d)){a=b[d];if(null!=this.key)throw Error("Trying to override a reserved event property: "+d);this[d]=a}};ta.prototype.get_root_event=function(){var a;for(a=this;null!=
a.parent_event;)a=a.parent_event;return a};ta.prototype.get_callstack=function(){var a;a=this.get_root_event;return a.callstack||(a.callstack=[])};Ra.Base=ta;var Sa=e.events,ua=function(){var a,b;b=arguments[0];a=2<=arguments.length?v.call(arguments,1):[];ua.__super__.constructor.apply(this,["property_change",{property:b}].concat(v.call(a)))};l(ua,e.events.Base);Sa.ThingPropertyChange=ua;var Ta=e.events,va=function(){var a,b;b=arguments[0];a=2<=arguments.length?v.call(arguments,1):[];va.__super__.constructor.apply(this,
["property_affected",{property:b}].concat(v.call(a)))};l(va,e.events.Base);Ta.ThingPropertyAffected=va;var Ua=e.events,wa=function(){var a,b;b=arguments[0];a=2<=arguments.length?v.call(arguments,1):[];wa.__super__.constructor.apply(this,[""+b+"_affected"].concat(v.call(a)))};l(wa,e.events.Base);Ua.ThingSpecificPropertyAffected=wa;var Va=e.events,xa=function(){var a,b,c,d,f,e,h;f=arguments[0];e=arguments[1];h=arguments[2];b=arguments[3];c=arguments[4];d=arguments[5];a=7<=arguments.length?v.call(arguments,
6):[];xa.__super__.constructor.apply(this,["sprite_moved",{x:f,y:e,z:h,prev_x:b,prev_y:c,prev_z:d}].concat(v.call(a)))};l(xa,e.events.Base);Va.SpriteMoved=xa;var Wa=e.events,T=function(){};T.prototype._get_events=function(){return this._events||(this._events={})};T.prototype._get_listeners=function(a){var b;b=this._get_events();return b[a]||(b[a]=[])};T.prototype.on=function(a,b,c){var d,f,e,h;if("function"===typeof b){d=this._get_listeners(a);a=!1;e=0;for(h=d.length;e<h;e++)if(f=d[e],f.listener===
b){a=!0;break}a||d.push({listener:b,scope:c||this});return this}};T.prototype.off=function(a,b){var c,d,f,g;if(b){c=this._get_listeners(a);f=0;for(g=c.length;f<g;f++)if(d=c[f],d.listener===b){e.utils.remove_val_from_array(c,d);c.length||this.remove_event(a);break}}else a?this.remove_event(a):this._events={};return this};T.prototype.remove_event=function(a){a?this._get_events()[a]=void 0:this._events=void 0;return this};T.prototype.trigger=function(a,b){var c,d;null==b&&(b=function(){});a.target=this;
d=this._get_listeners(a.name);c=function(f){var e;if(null==d[f])return b();e=d[f].listener.call(d[f].scope,a,function(a){return!0===a?b():c(f+1)});if(!0===e)return b();if(!1!==e)return c(f+1)};return c(0)};Wa.EventEmitter=T;var K=function(a){null!=a?this._restore(a):this._init()};K.prototype._init=function(){this.current_game_id=null;this.preferences={};this.games=[];return this.bones=[]};K.prototype._restore=function(a){var b,c,d;"string"===typeof a&&(a=JSON.parse(a));d=[];for(b in a)k.call(a,b)&&
(c=a[b],d.push(this[b]=c));return d};K.prototype.get_save_data=function(){return this};K.prototype.new_game=function(){var a;a=new e.Game;this.games.push(a.id);this.current_game_id=a.id;return a};K.prototype.end_game=function(a){var b;b=this.games.indexOf(a);this.games.splice(b,1);this.current_game_id=null;return this.bones.push(a)};K.prototype.get_gamesave_from_remote=function(a,b){return b(null)};K.prototype.restore_game_from_id=function(a,b){return this.get_gamesave_from_remote(a,function(a){return b(new e.Game(this,
a))})};K.prototype.restore_current_game=function(a){var b;if(!this.current_game_id)return a(new e.Game(this));b=localStorage.getItem("quicksave");null!=b&&JSON.parse(b).id===this.current_game_id||this.get_gamesave_from_remote(this.current_game_id,function(b){return function(d){return null==d?a(new e.Game(b)):a(new e.Game(b,d))}}(this));return a(new e.Game(this,b))};e.User=K;var ya=function(a){this.character=new a};ya.prototype.start=function(){var a;a=new e.ui.components.Query;a.data_source=new e.ui.components.data_sources.QueryDataSource("What's your character's name?",
null,[{name:"character_name"}]);var b=this;a.on_submit_callback=function(c){b.character.fullname=c.character_name;return a.dismiss(function(){return b.finish()})};return a.show()};ya.prototype.finish=function(){if(null!=this.on_complete_callback)return this.on_complete_callback(this.character)};e.CharacterGenerator=ya;var u=function(a,b){null!=b?"string"===typeof b?this._restore(a,b):this._init(a,b):this._init(a);this.perception_manager=new e.perception.PerceptionManager;this.timekeeper.bind_to_registry(this.registry);
this.world.bind_to_registry(this.registry);this.perception_manager.bind_to_registry(this.registry);var c=this;this.registry.display_message_to_console=function(){return c.display_message_to_console.apply(c,arguments)};var d=this;this.timekeeper.turn_offered_handler=function(){if(d.map)return d.map.draw_map()};this.action_manager.stop_listening_for_actions=function(){return keypress.stop_listening()}};u.prototype._create_from_constructor_string=function(){var a,b;b=arguments[0];a=2<=arguments.length?
v.call(arguments,1):[];b=e.utils.constructor_from_string(b);var c=function(){};c.prototype=b.prototype;c=new c;b=b.apply(c,a);return Object(b)===b?b:c};u.prototype._init=function(a,b){this.config=a;this.id=e.utils.generate_uuid(Math.random);this.seed=null!=b?b:+new Date;this.registry=this._create_from_constructor_string(this.config.thing_registry_class);this.timekeeper=this._create_from_constructor_string(this.config.timekeeper_class);this.world=new e.geography.World;this.action_manager=new e.actions.ActionManager(this.world);
return this.message_console=new e.MessageConsole};u.prototype._restore=function(a,b){var c;"string"===typeof b&&(b=JSON.parse(b));c=a.user_settings;this.config=b.config;this.config.user_settings=c;this.id=b.id;this.seed=b.seed;this.registry=this._create_from_constructor_string(this.config.thing_registry_class,b.registry);this.timekeeper=this._create_from_constructor_string(this.config.timekeeper_class,b.timekeeper);this.world=new e.geography.World(b.world);this.action_manager=new e.actions.ActionManager(this.world);
this.message_console=new e.MessageConsole(b.message_console);return this._protagonist_ready(this.registry.get_thing(this.world.protagonist))};u.prototype.set_protagonist=function(a){var b;this.registry.register_thing(a);b=this._create_from_constructor_string(this.config.player_character_class);this.registry.register_thing(b);a.give_sentience(b);this.world.init(b,this.seed,this.config.geography);return this._protagonist_ready(b)};u.prototype._protagonist_ready=function(a){var b=this;a.listen_for_actions_handler=
function(a,c){b.player_action_success_callback=a;b.player_action_failure_callback=c;return keypress.listen()};var c=this;a.offerred_turn_handler=function(){return c.quicksave()};this._bind_player_actions(a);return this.world.protagonist_ready(a)};u.prototype._get_save_data=function(a){null==a&&(a=!1);return{id:this.id,seed:this.seed,config:this.config,timekeeper:this.timekeeper.get_save_data(a),message_console:this.message_console.get_save_data(a),world:this.world.get_save_data(a),registry:this.registry.get_save_data(a)}};
u.prototype._get_quicksave_data=function(){return this._get_save_data(!0)};u.prototype._get_fullsave_data=function(){return this._get_save_data(!1)};u.prototype.quicksave=function(){var a;a=this._get_quicksave_data();if("function"===typeof this.quicksave_handler)return this.quicksave_handler(a)};u.prototype.fullsave=function(){var a;a=this._get_fullsave_data();"function"===typeof this.fullsave_handler&&this.fullsave_handler(a);return this.registry.remove_cached_things_from_local_storage()};u.prototype.display_message_to_console=
function(){var a,b,c;b=arguments[0];a=2<=arguments.length?v.call(arguments,1):[];return(c=this.message_console).show_message.apply(c,[b].concat(v.call(a)))};u.prototype.show_game_ui=function(){var a;a=new e.ui.components.TileMap;a.data_source=new e.ui.components.data_sources.TileMapDataSource(this.world,this.config.ui.tile_map);a.show();return this.map=a};u.prototype.start=function(){this.world.start();this.show_game_ui();return this.timekeeper.start()};u.prototype.end=function(){return this.timekeeper.end()};
u.prototype.exit=function(){"function"===typeof this.exit_handler&&this.exit_handler();this.world.remove();this.timekeeper.remove();return this.map.dismiss()};u.prototype._bind_player_actions=function(a){var b,c,d,f,g;c=[{keys:"w",action:e.actions.Walk,data:{x:0,y:-1}},{keys:"a",action:e.actions.Walk,data:{x:-1,y:0}},{keys:"s",action:e.actions.Walk,data:{x:0,y:1}},{keys:"d",action:e.actions.Walk,data:{x:1,y:0}}];var h=this;d=function(b){return keypress.combo(b.keys,function(){return h.action_manager.do_action(a,
b.action,b.data||{},function(a){return h.player_action_success_callback(a)},function(a){return h.player_action_failure_callback(a)})},!0)};f=0;for(g=c.length;f<g;f++)b=c[f],d(b);return keypress.combo("escape",function(a){return function(){return a.exit()}}(this))};e.Game=u;var Z=function(a){null!=a?this._restore(a):this._init()};Z.prototype._init=function(){this.message_history_length=0;return this.messages=[]};Z.prototype._restore=function(a){"string"===typeof a&&(a=JSON.parse(a));this.message_history_length=
a.message_history_length;return this.messages=a.messages};Z.prototype.show_message=function(){var a,b,c,d;c=arguments[0];for(a=2<=arguments.length?v.call(arguments,1):[];a.length;)d=a.shift(),b=c.indexOf("%@"),c=c.slice(0,b)+d+c.slice(b+2);return this._add_message(c)};Z.prototype._add_message=function(a){this.messages.push(a);if(0<this.message_history_length){for(a=[];this.messages.length>this.message_history_length;)a.push(this.messages.unshift());return a}};Z.prototype.get_save_data=function(){return{message_history_length:this.message_history_length,
message:this.messages}};e.MessageConsole=Z;var ja=function(a){this.cnames=a?a:[]};ja.prototype.get_save_data_from_object=function(a){var b,c;c=a.get_save_data();b=this.cnames.indexOf(a.constructor.cname);-1===b&&(this.cnames.push(a.constructor.cname),b=this.cnames.length-1);c.c=b;return c};ja.prototype.restore_object_from_data=function(a){var b,c;"string"===typeof a&&(a=JSON.parse(a));c=this.cnames[a.c];delete a.c;c=c.split(".");b=e;for(c.shift();c.length;)b=b[c.shift()];return new b(a)};ja.prototype.get_save_data=
function(){return this.cnames};e.ConstructorManager=ja;var da=function(){};da.prototype.bind_to_registry=function(a){var b,c,d;this.things=[];this.registry=a;a.on("registered_thing",this._add_thing_from_registry_event,this).on("unregistered_thing",this._remove_thing_from_registry_event,this).on("cached_thing",this._remove_thing_from_registry_event,this).on("uncached_thing",this._add_thing_from_registry_event,this);c=a.things;d=[];for(b in c)a=c[b],d.push(this._add_thing(a));return d};da.prototype._add_thing=
function(a){var b,c,d,f,g;f=this.subcategory_cnames;g=[];c=0;for(d=f.length;c<d;c++)if(b=f[c],b=e.utils.constructor_from_string(b),a instanceof b){this.things.push(a);"function"===typeof this.subcategory_thing_added&&this.subcategory_thing_added(a);break}else g.push(void 0);return g};da.prototype._add_thing_from_registry_event=function(a){return this._add_thing(a.thing)};da.prototype._remove_thing_from_registry_event=function(a){var b,c,d,f,g;f=this.subcategory_cnames;g=[];c=0;for(d=f.length;c<d;c++)if(b=
f[c],b=e.utils.constructor_from_string(b),a.thing instanceof b){e.utils.remove_val_from_array(this.things,a.thing);"function"===typeof this.subcategory_thing_removed&&this.subcategory_thing_removed(a.thing);break}else g.push(void 0);return g};e.RegistrySubcategory=da;var ka=function(){this.brains=[]};ka.prototype.bind_to_registry=function(a){var b,c,d;this.registry=a;a.on("registered_brain",this._add_brain_from_registry_event,this).on("unregistered_brain",this._remove_brain_from_registry_event,this).on("cached_brain",
this._remove_brain_from_registry_event,this).on("uncached_brain",this._add_brain_from_registry_event,this);c=a.things;d=[];for(b in c)k.call(c,b)&&(a=c[b],a instanceof e.things.Brain?d.push(this.brains.push(a)):d.push(void 0));return d};ka.prototype._add_brain_from_registry_event=function(a){return this.brains.push(a.thing)};ka.prototype._remove_brain_from_registry_event=function(a){return e.utils.remove_val_from_array(this.brains,a.thing)};e.BrainManager=ka;var A=function(a){null!=a?this._restore(a):
this._init()};A.prototype._init=function(){this.things=[];return this.time=0};A.prototype._restore=function(a){var b,c,d,f;"string"===typeof a&&(a=JSON.parse(a));this.things=[];f=a.things;c=0;for(d=f.length;c<d;c++)b=f[c],this.things.push(b);return this.time=a.time};A.prototype.bind_to_registry=function(a){var b,c,d,f,e,h;this.registry=a;a.on("registered_brain",function(a){return function(b){return a._add_thing(b.id,b.thing)}}(this)).on("unregistered_brain",function(a){return function(b){return a._remove_thing(b.id)}}(this)).on("cached_brain",
function(a){return function(b){return a._remove_thing(b.id)}}(this)).on("uncached_brain",function(a){return function(b){return a._add_thing(b.id,b.thing)}}(this));e=this.things;h=[];d=0;for(f=e.length;d<f;d++){c=e[d];b=a.get_thing(c.thing);c.thing=b;if(null==b)throw Error("Timekeeper had thing not in registry?!");h.push(void 0)}return h};A.prototype._add_thing=function(a,b,c){null==c&&(c=this.time);return this.things.push({thing:b,time:c})};A.prototype._remove_thing=function(a){var b,c,d;b=c=0;for(d=
this.things.length;0<=d?c<d:c>d;b=0<=d?++c:--c)if(this.things[b].thing.id===a){this.things.splice(b,1);break}};A.prototype.get_save_data=function(){var a,b,c,d,f;a={things:[],time:this.time};f=this.things;c=0;for(d=f.length;c<d;c++)b=f[c],a.things.push({thing:b.thing.id,time:b.time});return a};A.prototype._offer_next_turn=function(){var a;a=this._get_index_of_thing_with_least_time();this.time=this.things[a].time;return this._offer_turn(a)};A.prototype._get_index_of_thing_with_least_time=function(){var a,
b,c,d,f,e;a=null;b=Infinity;c=f=0;for(e=this.things.length;0<=e?f<e:f>e;c=0<=e?++f:--f)d=this.things[c].time,d<b&&(a=c,b=d);return a};A.prototype._offer_turn=function(a){var b;"function"===typeof this.turn_offered_handler&&this.turn_offered_handler();if(null==this.is_ended)return b=this.things.splice(a,1)[0],this.things.push(b),a=this.things.length-1,b=b.thing,b.take_turn(function(b){return function(d){if(null==b.is_ended)return b.things[a].time+=d,b._offer_next_turn()}}(this))};A.prototype.start=
function(){return this._offer_next_turn()};A.prototype.end=function(){return this.is_ended=!0};A.prototype.remove=function(){return this.registry.off()};e.TimeKeeper=A;var B=function(a){a?this._restore(a):this._init()};B.prototype._restore=function(a){this.sprites=a.sprites;this.positions=a.positions;return this.distances=new e.utils.RelationshipDictionary(a.distances)};B.prototype._init=function(){this.sprites=[];this.positions={};return this.distances=new e.utils.RelationshipDictionary};B.prototype.bind_to_registry=
function(a){var b,c,d,f;this.registry=a;a.on("registered_thing",this._add_thing_from_registry_event,this).on("unregistered_thing",this._remove_thing_from_registry_event,this).on("cached_thing",this._remove_thing_from_registry_event,this).on("uncached_thing",this._add_thing_from_registry_event,this);d=this.sprites;f=[];a=0;for(c=d.length;a<c;a++)b=d[a],b=this.registry.get_thing(b),this._bind_movement_for_sprite(b),f.push(this.sprites.push(b));return f};B.prototype._add_thing_from_registry_event=function(a){if(a.thing instanceof
e.things.Sprite)return this.sprites.push(a.thing),this._sprite_moved(a.thing,a.thing.x,a.thing.y),this._bind_movement_for_sprite(a.thing)};B.prototype._remove_thing_from_registry_event=function(a){if(a.thing instanceof e.things.Sprite)return this._unbind_movement_for_sprite(a.thing),e.utils.remove_val_from_array(this.sprites,a.thing)};B.prototype._bind_movement_for_sprite=function(a){return a.on("sprite_moved",this._sprite_movement_handler,this)};B.prototype._unbind_movement_for_sprite=function(a){return a.off("sprite_moved",
this._sprite_movement_handler,this)};B.prototype._sprite_movement_handler=function(a){return this._sprite_moved(a.target,a.x,a.y)};B.prototype._sprite_moved=function(a,b,c){var d,f,e,h,i;this.positions[a.id]={x:b,y:c};b=a.id;h=this.sprites;i=[];f=0;for(e=h.length;f<e;f++)c=h[f],a!==c&&(d=this.distances.get_value_for_keys(b,c.id),0!==d?i.push(this.distances.set_value_for_keys(b,c.id,0)):i.push(void 0));return i};B.prototype.get_save_data=function(){var a,b,c,d,f;a={sprites:[],positions:this.positions,
distances:this.distances.get_save_data()};f=this.sprites;c=0;for(d=f.length;c<d;c++)b=f[c],a.sprites.push(b.id);return a};B.prototype.get_path_distance_between=function(a,b){return this.distances.get_value_for_keys(a,b)};B.prototype.get_los_distance_between=function(a,b){return e.utils.get_distance_between_points(this.positions[a],this.positions[b])};e.SpriteDistanceManager=B;var q=function(){this.light_map=new e.utils.MatrixArray;this.subcategory_cnames=["engine.things.LightSource"];q.__super__.constructor.call(this)};
l(q,e.RegistrySubcategory);q.prototype._get_light_sources_that_need_updates=function(){var a,b,c,d,f;b=[];f=this.things;c=0;for(d=f.length;c<d;c++)a=f[c],a.needs_update&&b.push(a);return b};q.prototype._calculate_radius_for_intensity=function(a){return Math.round(30*a)};q.prototype._calculate_radius_for_light_source=function(a){return this._calculate_radius_for_intensity(a.intensity)};q.prototype._get_brightness_for_distance_and_intensity=function(a,b){var c;return c=Math.round(5*b*((30-(a+0.25))/
30))/5};q.prototype._get_affected_positions_for_origin_and_radius=function(a,b,c){var d,f,g,h,i,m,n,t,s,j,k;i=[];h=c+0.25;g=m=t=b-c;for(s=b+c+1;t<=s?m<s:m>s;g=t<=s?++m:--m){f=n=j=a-c;for(k=a+c+1;j<=k?n<k:n>k;f=j<=k?++n:--n)d=e.utils.get_distance_between_points([a,b],[f,g]),d<=h&&i.push([f,g])}return i};q.prototype._get_affected_tile_positions=function(a){return this._get_affected_positions_for_origin_and_radius(a.x,a.y,this._calculate_radius_for_light_source(a))};q.prototype.subcategory_thing_added=
function(a){a.on("light_intensity_updated",this._light_intensity_updated,this).on("light_color_updated",this._light_color_updated,this).on("light_position_updated",this._light_position_updated,this).on("light_applied",this._new_light_added_handler,this);return this._new_light_added(a)};q.prototype.subcategory_thing_removed=function(a){a.off("light_intensity_updated",this._light_intensity_updated).off("light_color_updated",this._light_color_updated).off("light_position_updated",this._light_position_updated).off("light_applied",
this._new_light_added_handler);return this._light_removed(a)};q.prototype._new_light_added_handler=function(a){return this._new_light_added(a.target)};q.prototype._new_light_added=function(a){var b,c,d,f,e,h,i;if(a.has_target){c=this._get_affected_tile_positions(a);i=[];e=0;for(h=c.length;e<h;e++)b=c[e],d=b[0],f=b[1],b=this.light_map.get_value_at(d,f),b||(b=new ca,this.light_map.set_value_at(d,f,b)),b=b||new ca,b.light_sources.push(a),i.push(b.needs_update=!0);return i}};q.prototype._light_removed=
function(a){var b,c,d,f,g,h;d=this._get_affected_tile_positions(a);h=[];f=0;for(g=d.length;f<g;f++)c=d[f],b=c[0],c=c[1],b=this.light_map.get_value_at(b,c),0<=R.call(b.light_sources,a)?(e.utils.remove_val_from_array(b.light_sources,a),h.push(b.needs_update=!0)):h.push(void 0);return h};q.prototype._light_intensity_updated=function(a){var b,c,d,f,g,h,i;c=a.target;b=a.value;d=a.prev_value;a=Math.max(b,d);a=this._calculate_radius_for_intensity(a);f=this._get_affected_positions_for_origin_and_radius(c.x,
c.y,a);a=Math.min(b,d);a=this._calculate_radius_for_intensity(a);a=this._get_affected_positions_for_origin_and_radius(c.x,c.y,a);b=b>d;h=0;for(i=f.length;h<i;h++)g=f[h],d=this.light_map.get_value_at(g[0],g[1]),d||(d=new ca,this.light_map.set_value_at(g[0],g[1],d)),d.needs_update=!0,b?0>R.call(d.light_sources,c)&&d.light_sources.push(c):e.utils.remove_val_from_array(d.light_sources,c);i=[];f=0;for(h=a.length;f<h;f++)g=a[f],d=this.light_map.get_value_at(g[0],g[1]),b?i.push(void 0):(d.light_sources.push(c),
i.push(d.needs_update=!0));return i};q.prototype._light_color_updated=function(a){var b,c,d,f,a=a.target;d=this._get_affected_positions_for_origin_and_radius(a.x,a.y,this._calculate_radius_for_light_source(a));f=[];a=0;for(c=d.length;a<c;a++)b=d[a],b=this.light_map.get_value_at(b[0],b[1]),f.push(b.needs_update=!0);return f};q.prototype._light_position_updated=function(a){var b,c,d,f,g,h;b=a.target;d=a.x;f=a.y;c=a.prev_x;a=a.prev_y;d=this._get_affected_positions_for_origin_and_radius(d,f,this._calculate_radius_for_light_source(b));
f=this._get_affected_positions_for_origin_and_radius(c,a,this._calculate_radius_for_light_source(b));g=0;for(h=f.length;g<h;g++)a=f[g],c=this.light_map.get_value_at(a[0],a[1]),c.needs_update=!0,e.utils.remove_val_from_array(c.light_sources,b);f=0;for(g=d.length;f<g;f++)a=d[f],c=this.light_map.get_value_at(a[0],a[1]),c||(c=new ca,this.light_map.set_value_at(a[0],a[1],c)),c.needs_update=!0,c.add_light_source(b)};q.prototype.update=function(){var a;a=[];this.light_map.for_each(function(b){return function(c,
d,f,g){var h,i,m,n;if(c.needs_update&&(!g||!(d<g.left||d>g.right||f<g.top||f>g.bottom))&&b.get_tile_at_handler(d,f)){c.reset();n=c.light_sources;i=0;for(m=n.length;i<m;i++)g=n[i],b.has_los_between_points_handler(d,f,g.x,g.y)&&(h=e.utils.get_distance_between_points([d,f],[g.x,g.y]),h=b._get_brightness_for_distance_and_intensity(h,g.intensity),0<h&&c.add_light(g.color,h));return a.push({x:d,y:f,amount:c.amount})}}}(this));return a};q.prototype.light_level_at_point=function(a,b){var c,d;c=0;if(d=this.light_map.get_value_at(a,
b))c=d.amount;return c};q.prototype.light_color_at_point=function(a,b){var c,d;c="000000";if(d=this.light_map.get_value_at(a,b))c=d.color;return c};e.LightingManager=q;var la=function(){this.light_sources=[];this.reset()};la.prototype.reset=function(){this.amount=0;this.color="000000";return this.needs_update=!1};la.prototype.add_light_source=function(a){if(0>R.call(this.light_sources,a))return this.light_sources.push(a)};la.prototype.add_light=function(a,b){this.amount+=b;a=e.utils.multiply_hex_number(a,
b);return this.color=e.utils.add_hex_colors(this.color,a)};ca=la;var Xa=e.perception,ma=function(a){null!=a?this._restore(a):this._init()};ma.prototype._restore=function(a){this._thing_id=a._thing_id;return this.sense_levels=a.sense_levels};ma.prototype._init=function(){this._thing_id=null;return this.sense_levels={sight:0,hearing:0,smelling:0,touch:0}};ma.prototype.get_property=function(a,b){if("function"===typeof this.get_property_handler)return this.get_property_handler(a,this._thing_id,b,this.sense_levels)};
Xa.Perceived=ma;var Ya=e.perception,U=function(){};U.prototype.filter=function(a,b,c,d,f,e){var h,i;h=!1;for(i in e)if(k.call(e,i)&&(h=e[i],h=this._can_perceive_thing_property(a,b,c,d,f,i,h)))break;if(h)return b[c]};U.prototype._can_perceive_thing_property=function(a,b,c,d,f,e,h){a=this["_can_perceive_thing_property_with_"+e];return"function"===typeof a?a(b,c,d,f,h):!1};U.prototype._can_perceive_thing_property_with_sight=function(a,b,c,d,f,e){return 0<e};U.prototype._can_perceive_thing_property_with_hearing=
function(a,b,c,d,f,e){return 0<e};U.prototype._can_perceive_thing_property_with_smelling=function(a,b,c,d,f,e){return 0<e};U.prototype._can_perceive_thing_property_with_touch=function(a,b,c,d,f,e){return 0<e};Ya.PerceptionFilter=U;var Za=e.perception,Ea=function(){this.brain_manager=new e.BrainManager};Ea.prototype.bind_to_registry=function(a){this.registry=a;return this.brain_manager.bind_to_registry(a)};Za.PerceptionManager=Ea;var $a=e.geography,j=function(a){a?this._restore(a):this._init();this.lighting_manager=
new e.LightingManager;var b=this;this.lighting_manager.get_tile_at_handler=function(a,c){return b.get_tile_at(a,c)};var c=this;this.lighting_manager.has_los_between_points_handler=function(){return c.has_visual_los_between_points.apply(c,arguments)}};j.prototype._restore=function(a){var b,c,d;"string"===typeof a&&(a=JSON.parse(a));this.seed=a.seed;this.protagonist=a.protagonist;this.constructor_manager=new e.ConstructorManager(a.constructor_manager);this.geography_config=JSON.parse(a.geography_config);
this.loading_buffer=this.geography_config.loading_buffer;this.zone_size=this.geography_config.zone_size;this.zone_manager=new (e.utils.constructor_from_string(this.geography_config.zone_manager_class))(a.zone_manager);this.strata={};c=a.strata;d=[];for(b in c)a=c[b],d.push(this.strata[b]=this._create_stratum(a));return d};j.prototype._init=function(){this.constructor_manager=new e.ConstructorManager;return this.strata={}};j.prototype.bind_to_registry=function(a){this.registry=a;return this.lighting_manager.bind_to_registry(a)};
j.prototype.protagonist_ready=function(a){a=a.get_host();return this._track_protagonist_to(a.x,a.y,a.z)};j.prototype.init=function(a,b,c){this.protagonist=a.id;this.geography_config=c;this.loading_buffer=c.loading_buffer;this.zone_size=c.zone_size;this.seed=b;this.zone_manager=new (e.utils.constructor_from_string(c.zone_manager_class));this.zone_manager.random=new e.random.Alea(null,[this.seed]);this.zone_manager.init();b=this._get_spawn_point();a=this.registry.get_thing(this.protagonist);return a.get_host().move_to(b.x,
b.y,b.z)};j.prototype.get_save_data=function(){var a,b,c,d;b={geography_config:JSON.stringify(this.geography_config),seed:this.seed,protagonist:this.protagonist,constructor_manager:this.constructor_manager.get_save_data(),zone_manager:this.zone_manager.get_save_data(),strata:{}};d=this.strata;for(a in d)c=d[a],b.strata[a]=c.get_save_data();return b};j.prototype.start=function(){return this._track_protagonist()};j.prototype.remove=function(){return this._stop_tracking_protagonist()};j.prototype.has_visual_los_between_points=
function(a,b,c,d){var f,e,h,i,m,n,t;m=!0;f=Math.abs(c-a);e=Math.abs(d-b);n=a<c?1:-1;t=b<d?1:-1;for(i=f-e;!(a===c&&b===d);)if(h=i<<1,h>-e&&(i-=e,a+=n),h<f&&(i+=f,b+=t),h=this.get_tile_at(a,b),!h||h.is_opaque){m=!1;break}return m};j.prototype.light_level_at_point=function(a,b){return this.lighting_manager.light_level_at_point(a,b)};j.prototype.light_color_at_point=function(a,b){return this.lighting_manager.light_color_at_point(a,b)};j.prototype.update_light_map=function(a){return this.lighting_manager.update(a)};
j.prototype.get_protagonist=function(){return this.registry.get_thing(this.protagonist)};j.prototype.get_tile_at=function(a,b){return this.tiles.get_value_at(a,b)};j.prototype.get_seed_for_coordinate=function(a,b,c){var d,f,a=0<=a?2*a:-2*a-1,b=0<=b?2*b:-2*b-1,c=0<=c?2*c:-2*c-1;f=Math.max(a,b,c);d=Math.pow(f,3)+2*f*c+c;f===c&&(d+=Math.pow(Math.max(a,b),2));return this.seed+(b>=a?d+(a+b):d+b)};j.prototype._create_sprite_from_string_at=function(a,b,c){a=new (e.utils.constructor_from_string(a));this.registry.register_thing(a);
a.move_to(b,c,b);return a};j.prototype._track_protagonist=function(){var a;a=this.get_protagonist();this._tracked_host=a.get_host();a.on("host_affected",this._host_changed_handler,this);return this._tracked_host.on("sprite_moved",this._sprite_moved_handler,this)};j.prototype._stop_tracking_protagonist=function(){this.get_protagonist().off("host_affected",this._host_changed_handler);return this._tracked_host.off("sprite_moved",this._sprite_moved_handler)};j.prototype._host_changed_handler=function(){this._tracked_host.off("sprite_moved",
this._sprite_moved_handler);this._tracked_host=protagonist.get_host();this._tracked_host.on("sprite_moved",this._sprite_moved_handler,this);return this._track_protagonist_to(this._tracked_host.x,this._tracked_host.y,this._tracked_host.z)};j.prototype._sprite_moved_handler=function(a){return this._track_protagonist_to(a.x,a.y,a.z)};j.prototype._track_protagonist_to=function(a,b,c){var d,f,g,h,i,m,n,t,s,k,j,l,o,q,p,u,r;t=this._get_stratum_at_level(c);t.create_neighbor_zones_at(a,b);this.protagonist_stratum_level!==
c?(this.protagonist_stratum_level=c,this.tiles=new e.utils.MatrixArray):(i=a-this.loading_buffer,g=a+this.loading_buffer,m=b-this.loading_buffer,h=b+this.loading_buffer,s=new e.utils.MatrixArray,this.tiles.for_each(function(a){return function(b,c,d){return i<=c&&c<=g&&m<=d&&d<=h?s.set_value_at(c,d,!0):a.tiles.remove_value_at(c,d)}}(this)));n=k=q=b-this.loading_buffer;for(p=b+this.loading_buffer;q<=p?k<=p:k>=p;n=q<=p?++k:--k){b=j=u=a-this.loading_buffer;for(r=a+this.loading_buffer;u<=r?j<=r:j>=r;b=
u<=r?++j:--j)if(!(s&&null!=s.get_value_at(b,n))){d=t.create_tile_at(b,n);this.tiles.set_value_at(b,n,d);f=t.get_and_remove_sprite_constructor_strings_at(b,n);l=0;for(o=f.length;l<o;l++)d=f[l],this._create_sprite_from_string_at(d,b,n,c)}}};j.prototype._create_stratum=function(a){var b;b=new e.geography.Stratum(a);b.zone_size=this.zone_size;b.constructor_manager=this.constructor_manager;var c=this;b.get_seed_for_coordinate_handler=function(a,d){var e;e=c._get_level_of_stratum(b);return c.get_seed_for_coordinate(a,
d,e)};var d=this;b.get_zone_info_handler=function(a,c){var e;e=d._get_level_of_stratum(b);return d.zone_manager.get_zone_info_at(a,c,e)};return b};j.prototype._get_level_of_stratum=function(a){var b,c,d;d=this.strata;for(c in d)if(b=d[c],b===a)return c};j.prototype._get_stratum_at_level=function(a){var b;b=this.strata[a];b||(b=this._create_stratum(),this.strata[a]=b);return b};j.prototype._get_spawn_point=function(){var a,b;b=this._get_spawn_stratum_level();a=this._get_spawn_zone_position();a=this._get_stratum_at_level(b).get_zone_at_zone_position(a.x,
a.y).get_valid_spawn_point();a.z=b;return a};j.prototype._get_spawn_stratum_level=function(){return 0};j.prototype._get_spawn_zone_position=function(){return{x:0,y:0}};$a.World=j;var ab=e.geography,C=function(a){a?this._restore(a):this._init()};C.prototype._restore=function(a){this.zones=new e.utils.MatrixArray(a.zones);return this.zones.for_each(function(a){return function(c,d,e){return a.zones.set_value_at(d,e,a.constructor_manager.restore_object_from_data(c))}}(this))};C.prototype._init=function(){return this.zones=
new e.utils.MatrixArray};C.prototype.get_save_data=function(){return{}.zones=this.zones.get_save_data(function(a){return function(b){return a.constructor_manager.get_save_data_from_object(b)}}(this))};C.prototype.create_tile_at=function(a,b){return new (this._get_tile_constructor_at(a,b))};C.prototype.get_and_remove_sprite_constructor_strings_at=function(a,b){var c,d,e;e=this._get_zone_at(a,b);c=this._get_local_coordinate_from_global_coordinate(a,b);d=e.get_sprite_constructor_strings_at(c.x,c.y);
d.length&&e.remove_sprite_constructors_at(c.x,c.y);return d};C.prototype.get_zone_at_zone_position=function(a,b){var c;(c=this.zones.get_value_at(a,b))||(c=this._create_zone_at(a,b));return c};C.prototype.create_neighbor_zones_at=function(a,b){var c,d,e,g,h,i,m;c=this._get_zone_coordinate_from_global_coordinate(a,b);m=[];e=g=h=c.y-1;for(i=c.y+1;h<=i?g<=i:g>=i;e=h<=i?++g:--g)m.push(function(){var a,b,g,h;h=[];d=a=b=c.x-1;for(g=c.x+1;b<=g?a<=g:a>=g;d=b<=g?++a:--a)h.push(this.get_zone_at_zone_position(d,
e));return h}.call(this));return m};C.prototype._create_zone_at=function(a,b){var c,d,e;if("function"===typeof this.get_zone_info_handler)return e=this.get_zone_info_handler(a,b),d=new e.constructor,"function"===typeof this.get_seed_for_coordinate_handler&&(c=this.get_seed_for_coordinate_handler(a,b)),d.init(this.zone_size,c,e.entrances,e.pathways),this.zones.set_value_at(a,b,d),d};C.prototype._get_tile_constructor_at=function(a,b){var c,d;d=this._get_zone_at(a,b);c=this._get_local_coordinate_from_global_coordinate(a,
b);return d.get_tile_constructor_at(c.x,c.y)};C.prototype._get_zone_at=function(a,b){var c;c=this._get_zone_coordinate_from_global_coordinate(a,b);return this.zones.get_value_at(c.x,c.y)};C.prototype._get_zone_coordinate_from_global_coordinate=function(a,b){return{x:Math.floor(a/this.zone_size),y:Math.floor(b/this.zone_size)}};C.prototype._get_local_coordinate_from_global_coordinate=function(a,b){a%=this.zone_size;b%=this.zone_size;0>a&&(a+=this.zone_size);0>b&&(b+=this.zone_size);return{x:a,y:b}};
ab.Stratum=C;var bb=e.geography,ea=function(a){a&&this._restore(a)};ea.prototype._restore=function(a){var b,c,d;"string"===typeof a&&(a=JSON.parse(a));d=[];for(b in a)k.call(a,b)&&(c=a[b],"random"===b&&(c=new e.random.Alea(c)),d.push(this[b]=c));return d};ea.prototype.get_save_data=function(){var a,b,c;b={};for(a in this)k.call(this,a)&&(c=this[a],"random"===a&&(c=c.get_save_data()),b[a]=c);JSON.stringify(b);return b};ea.prototype.init=function(){};ea.prototype.get_zone_info_at=function(){return{constructor:e.geography.zones.Base,
entrances:[],pathways:[]}};bb.ZoneManager=ea;var cb=e.geography,Fa=function(){};Fa.prototype.constuctor=function(a,b){this.entrances=a;this.exits=b};cb.ZonePath=Fa;e.geography.ZonePoint=function(a,b,c){this.x=a;this.y=b;this.exit_directions=c};var db=e.geography.zones,D=function(a){null!=a&&this._restore(a)};D.cname="engine.geography.zones.Base";D.prototype.tile_constructors=["engine.geography.tiles.Base"];D.prototype.sprite_constructors=[];D.prototype._restore=function(a){this.size=a.size;this.random=
new e.random.Alea(a.random);return this.tile_constructor_indices=a.tile_constructor_indices};D.prototype.init=function(a,b,c,d){this.size=a;this.random=new e.random.Alea(null,[b]);this.tile_constructor_indices=this._init_tiles(c,d);return this.sprite_constructor_indices=this._init_sprites()};D.prototype.get_tile_constructor_at=function(a,b){return e.utils.constructor_from_string(this.tile_constructors[this.tile_constructor_indices[a+b*this.size]])};D.prototype.get_sprite_constructor_strings_at=function(a,
b){var c,d,e,g,h;e=this.sprite_constructor_indices.get_value_at(a,b);c=[];if(e){g=0;for(h=e.length;g<h;g++)d=e[g],(d=this.sprite_constructors[d])&&c.push(d)}return c};D.prototype.remove_sprite_constructors_at=function(a,b){return this.sprite_constructor_indices.remove_value_at(a,b)};D.prototype.get_valid_spawn_point=function(){return{x:0,y:0}};D.prototype.get_save_data=function(){return{size:this.size,random:this.random.get_save_data(),tile_constructor_indices:this.tile_constructor_indices}};D.prototype._init_tiles=
function(){var a,b,c,d,e;a=[];b=0;for(d=this.size;0<=d?b<d:b>d;0<=d?++b:--b){c=0;for(e=this.size;0<=e?c<e:c>e;0<=e?++c:--c)a.push(0)}return a};D.prototype._init_sprites=function(){return new e.utils.MatrixArray};db.Base=D;var eb=e.geography.tiles,P=function(){};P.cname="engine.geography.tiles.Base";P.prototype.x=null;P.prototype.y=null;P.prototype.z=null;P.prototype.is_impassable=!1;P.prototype.is_opaque=!1;P.prototype.is_obstacle=!1;eb.Base=P;var fb=e.geography.tiles,na=function(){return na.__super__.constructor.apply(this,
arguments)};l(na,e.geography.tiles.Base);na.cname="engine.geography.tiles.Floor";fb.Floor=na;var gb=e.geography.tiles,V=function(){return V.__super__.constructor.apply(this,arguments)};l(V,e.geography.tiles.Base);V.cname="engine.geography.tiles.Wall";V.prototype.is_impassable=!0;V.prototype.is_obstacle=!0;V.prototype.is_opaque=!0;gb.Wall=V;var hb=e.geography.tiles,fa=function(){return fa.__super__.constructor.apply(this,arguments)};l(fa,e.geography.tiles.Base);fa.cname="engine.geography.tiles.Obstacle";
fa.prototype.is_obstacle=!0;hb.Obstacle=fa;var ib=e.geography.tiles,aa=function(){return aa.__super__.constructor.apply(this,arguments)};l(aa,e.geography.tiles.Base);aa.cname="engine.geography.tiles.Window";aa.prototype.is_impassable=!0;aa.prototype.is_obstacle=!0;ib.Window=aa;var jb=e.ui.components,o=function(a){this.parent_component=a;this.namespace="ns_"+e.utils.generate_uuid(Math.random);this.sub_components=[];this.init()};o.prototype.should_block_global_binds=!1;o.prototype.styles=[];o.prototype.init=
function(){};o.prototype.show=function(a,b){var c,d,e,g,h,i;null==b&&(b=!1);if(!this.element){this.element=this.render();this.element.id=""+this.namespace;d="";i=this.styles;g=0;for(h=i.length;g<h;g++)e=i[g],d+=""+e+" ";this.element.className=d;$(window).on("resize."+this.namespace,function(a){return function(){return a.window_resize()}}(this))}h=this.sub_components;e=0;for(g=h.length;e<g;e++)d=h[e],d.render();this.block_global_binds();this.append_component();h=this.sub_components;e=0;for(g=h.length;e<
g;e++)d=h[e],d.show(null,!0);var m=this;c=function(){m.has_appeared();m.bind_events();if("function"===typeof a)return a()};return b?c():this.animate_appearance(function(){return c()})};o.prototype.dismiss=function(a,b){var c;null==b&&(b=!1);var d=this;c=function(){var b,c,e,i;d.has_disappeared();d.unbind_events();i=d.sub_components;c=0;for(e=i.length;c<e;c++)b=i[c],b.dismiss(null,!0);$(window).off("resize."+d.namespace);d.remove_component();d.unblock_global_binds();d.data_source&&d.data_source.remove();
if("function"===typeof a)return a()};return b?c():this.animate_disapperance(function(){return c()})};o.prototype.create_element=function(){return crel.apply(null,arguments)};o.prototype.block_global_binds=function(){if(this.should_block_global_binds)return this.bindings_previous=keypress.get_registered_combos(),keypress.reset()};o.prototype.unblock_global_binds=function(){var a;if(this.should_block_global_binds&&null!=(a=this.bindings_previous)&&a.length)return keypress.register_many(this.bindings_previous)};
o.prototype.has_appeared=function(){};o.prototype.has_disappeared=function(){};o.prototype.bind_events=function(){};o.prototype.unbind_events=function(){};o.prototype.render=function(){};o.prototype.animate_appearance=function(a){return a()};o.prototype.animate_disapperance=function(a){return a()};o.prototype.append_component=function(){var a;a=null!=this.parent_component?this.parent_component.append_to_element:document.body;if(this.element)return a.appendChild(this.element)};o.prototype.remove_component=
function(){var a;if(this.element)return null!=(a=this.element.parentNode)?a.removeChild(this.element):void 0};o.prototype.window_resize=function(){};o.prototype.add_sub_component=function(a){return this.sub_components.push(a)};o.prototype.reload_data=function(){if(this.data_source)return this.dismiss(null,!0),this.show(null,!0)};jb.Base=o;var kb=e.ui.components,L=function(){return L.__super__.constructor.apply(this,arguments)};l(L,e.ui.components.Base);L.prototype.styles=["menu"];L.prototype.render=
function(){var a,b,c,d;b=this.create_element("ul");a=c=0;for(d=this.data_source.length;0<=d?c<d:c>d;a=0<=d?++c:--c)b.appendChild(this.create_element("li",this.create_element("span",""+this.data_source.get_option_text_at_index(a))));return b};L.prototype.bind_events=function(){var a;a=this;return $("#"+this.namespace+" li").on("click",function(){var b;b=a.data_source.get_option_selection_callback_at_index($(this).index());if(null!=b)return b()})};L.prototype.unbind_events=function(){return $(""+this.namespace+
" li").off("click")};L.prototype.animate_appearance=function(a){this.element.setAttribute("style","opacity:0;top:-500px;position:relative");return $(this.element).animate({opacity:1,top:0},500,a)};L.prototype.animate_disapperance=function(a){return $(this.element).animate({opacity:0},200,a)};kb.Menu=L;var lb=e.ui.components,Q=function(){return Q.__super__.constructor.apply(this,arguments)};l(Q,e.ui.components.Base);Q.prototype.styles=["query"];Q.prototype.render=function(){var a,b,c,d,e,g,h;a=this.create_element("div",
this.data_source.query_title?this.create_element("h1",this.data_source.query_title):null,e=this.create_element("ul"));b=g=0;for(h=this.data_source.length;0<=h?g<h:g>h;b=0<=h?++g:--g)c=this.data_source.get_query_label_at_index(b),d=this.create_element("li"),c&&d.appendChild(this.create_element("label",c)),d.appendChild(this.create_element("input",{type:"text",name:""+this.data_source.get_query_name_at_index(b)})),e.appendChild(d);a.appendChild(this.create_element("button",{type:"submit"},this.data_source.submit_label||
"Submit"));return a};Q.prototype.bind_events=function(){return $("#"+this.namespace+" button").on("click",function(a){return function(){return a.submit_query()}}(this))};Q.prototype.unbind_events=function(){return $("#"+this.namespace+" button").off("click")};Q.prototype.submit_query=function(){var a;if(null!=this.on_submit_callback)return a={},$("#"+this.namespace+" input").each(function(b,c){return a[c.getAttribute("name")]=c.value}),this.on_submit_callback(a)};lb.Query=Q;var mb=e.ui.components,
w=function(){return w.__super__.constructor.apply(this,arguments)};l(w,e.ui.components.Base);w.prototype.styles=["tile_map"];w.prototype.__defineGetter__("data_source",function(){return this._data_source});w.prototype.__defineSetter__("data_source",function(a){this._data_source=a;this.viewport_width=2*a.view_width*a.tile_width+a.tile_width;return this.viewport_height=2*a.view_height*a.tile_height+a.tile_height});w.prototype.render=function(){this.background_element=this.create_element("canvas",{id:""+
this.namespace+"_background","class":"canvas_background",width:this.viewport_width,height:this.viewport_height});this.lighting_element=this.create_element("canvas",{id:""+this.namespace+"_lighting","class":"canvas_lighting",width:this.viewport_width,height:this.viewport_height});this.foreground_element=this.create_element("canvas",{id:""+this.namespace+"_foreground","class":"canvas_foreground",width:this.viewport_width,height:this.viewport_height});this.composite_element=this.create_element("canvas",
{id:""+this.namespace+"_composite","class":"canvas_composite",width:this.viewport_width,height:this.viewport_height});return this.create_element("div",this.composite_element)};w.prototype.has_appeared=function(){var a,b=this;a=function(){return window.requestAnimationFrame(function(){b.should_draw_map&&(b.should_draw_map=!1,b._draw_map());return a()})};return a()};w.prototype.draw_map=function(){return this.should_draw_map=!0};w.prototype._draw_map=function(){var a,b,c,d,e,g;a=this.data_source.center_x;
c=this.data_source.center_y;g=this.data_source.z;b=this.center_x-a;d=this.center_y-c;e=g!==this.z;this.center_x=a;this.center_y=c;this.z=g;a=this.data_source.update_light_map({top:this.center_y-this.data_source.view_height,bottom:this.center_y+this.data_source.view_height,left:this.center_x-this.data_source.view_width,right:this.center_x+this.data_source.view_width});this.draw_background(b,d,e);this.draw_foreground();this.draw_lighting(b,d,e,a);return this.draw_composite()};w.prototype.draw_background=
function(a,b,c){var d,f,g,h,i,m,n,k,j,l,o,p,q,r,u,v,w;d=this.background_element.getContext("2d");h=this.data_source;r=h.view_width;q=h.view_height;o=h.tile_width;l=h.tile_height;c||d.drawImage(this.background_element,a*o,b*l);n=m=0;i=this.center_x-r;k=this.center_x+r;p=this.center_y-q;f=this.center_y+q;for(u=v=p;p<=f?v<=f:v>=f;u=p<=f?++v:--v){for(g=w=i;i<=k?w<=k:w>=k;g=i<=k?++w:--w){if(c||m<a||m>2*r+a||n<b||n>2*q+b)j=h.get_tile_at(g,u),g="#000",j&&("engine.geography.tiles.Floor"===j.constructor.cname?
g="#AAA":"engine.geography.tiles.Wall"===j.constructor.cname&&(g="#844")),d.fillStyle="rgba("+e.utils.hex_to_rgb(g)+", 1)",d.fillRect(m*o,n*l,o,l);m+=1;m>=2*r+1&&(m=0)}n+=1}};w.prototype.draw_foreground=function(){var a;a=this.foreground_element.getContext("2d");a.fillStyle="rgba("+e.utils.hex_to_rgb("#00FF00")+", 1)";console.log("FILL STYLE: "+a.fillStyle);return a.fillRect(this.data_source.view_width*this.data_source.tile_width,this.data_source.view_height*this.data_source.tile_height,this.data_source.tile_width,
this.data_source.tile_height)};w.prototype.draw_lighting=function(){var a,b,c,d,f,g,h,i,m,k,j,l,o,p,q,r;d=this.lighting_element.getContext("2d");b=this.data_source;m=b.view_width;i=b.view_height;h=b.tile_width;g=b.tile_height;l=o=0;for(q=this.viewport_height/g;0<=q?o<q:o>q;l=0<=q?++o:--o){j=p=0;for(r=this.viewport_width/h;0<=r?p<r:p>r;j=0<=r?++p:--p)if(a=j+(this.center_x-m),c=l+(this.center_y-i),k=b.visibility_at_point(a,c),f=1-k,d.clearRect(j*h,l*g,h,g),0<f&&(d.globalCompositeOperation="source-over",
d.fillStyle="rgba(0, 0, 0, "+f+")",d.fillRect(j*h,l*g,h,g)),0<k)a=b.light_color_at_point(a,c),a=e.utils.hex_to_rgb(a),d.globalCompositeOperation="lighten",d.fillStyle="rgba("+a+", 1)",d.fillRect(j*h,l*g,h,g)}};w.prototype.draw_composite=function(){var a;a=this.composite_element.getContext("2d");a.globalCompositeOperation="source-over";a.drawImage(this.background_element,0,0);a.drawImage(this.foreground_element,0,0);a.globalCompositeOperation="multiply";return a.drawImage(this.lighting_element,0,0)};
mb.TileMap=w;var nb=e.ui.components.data_sources,za=function(){};za.prototype.remove=function(){return this.undbind_events()};za.prototype.undbind_events=function(){};nb.Base=za;var ob=e.ui.components.data_sources,ga=function(a){this._menu_options=a};l(ga,e.ui.components.data_sources.Base);ga.prototype.__defineGetter__("length",function(){return this._menu_options.length});ga.prototype.get_option_text_at_index=function(a){return this._menu_options[a].text};ga.prototype.get_option_selection_callback_at_index=
function(a){return this._menu_options[a].selection_callback};ob.MenuDataSource=ga;var pb=e.ui.components.data_sources,W=function(a,b,c){this._title=a;this._submit_label=b;this._queries=c};l(W,e.ui.components.data_sources.Base);W.prototype.__defineGetter__("length",function(){return this._queries.length});W.prototype.__defineGetter__("query_title",function(){return this._title});W.prototype.__defineGetter__("submit_label",function(){return this._submit_label});W.prototype.get_query_label_at_index=
function(a){return this._queries[a].label};W.prototype.get_query_name_at_index=function(a){return this._queries[a].name};pb.QueryDataSource=W;var qb=e.ui.components.data_sources,E=function(a,b){this.world=a;this.view_width=b.view_width;this.view_height=b.view_height;this.tile_width=b.tile_width;this.tile_height=b.tile_height;this.protagonist=this.world.get_protagonist();this.host=this.protagonist.get_host();this.protagonist.on("host_affected",this._host_changed_handler,this);this.host.on("sprite_moved",
this._update_protagonist_location,this);this._update_protagonist_location()};l(E,e.ui.components.data_sources.Base);E.prototype.__defineGetter__("center_x",function(){return Math.floor(this.x+this.host_width/2)});E.prototype.__defineGetter__("center_y",function(){return Math.floor(this.y+this.host_height/2)});E.prototype.__defineGetter__("sprites",function(){return[]});E.prototype.__defineSetter__("data_source",function(a){return this.data_source=a});E.prototype._host_changed_handler=function(){this.host.off("sprite_moved",
this._update_protagonist_location);this.host=this.protagonist.get_host();this.host.on("sprite_moved",this._update_protagonist_location,this);return this._update_protagonist_location()};E.prototype._update_protagonist_location=function(){this.x=this.host.x;this.y=this.host.y;this.z=this.host.z;this.host_width=this.host.width;return this.host_height=this.host.height};E.prototype.get_tile_at=function(a,b){return this.world.get_tile_at(a,b)};E.prototype.visibility_at_point=function(a,b,c){var d,e,g;g=
0;d=this.host.x;e=this.host.y;10===this.protagonist.senses.touch?g+=1:10===this.protagonist.senses.sight&&this.world.has_visual_los_between_points(a,b,d,e)&&(c=null!=c?c:this.world.light_level_at_point(a,b),g+=c);0<this.protagonist.senses.touch&&1>=Math.abs(a-d)&&1>=Math.abs(b-e)&&(g+=0.5);return g=Math.min(1,g)};E.prototype.light_color_at_point=function(a,b){return this.world.light_color_at_point(a,b)};E.prototype.update_light_map=function(a){return this.world.update_light_map(a)};E.prototype.unbind_events=
function(){return this.host.off("sprite_moved",this._update_protagonist_location)};qb.TileMapDataSource=E;e.things.define_getter=function(a,b){return this.prototype.__defineGetter__(a,function(){var c;c=b.call(this);return c=this.check_for_property_modifiers(a,c)})};e.things.define_setter=function(a,b){return this.prototype.__defineSetter__(a,function(c){b.call(this,c);return this.trigger(new e.events.ThingPropertyChange(a))})};e.things.define_defaults=function(a){var b,c,d;d=[];for(b in a)k.call(a,
b)&&(c=a[b],this.prototype["_"+b]=c,d.push(function(a){return function(b){e.things.define_setter.call(a,b,function(a){return this["_"+b]=a});return e.things.define_getter.call(a,b,function(){var a,d,e;if((c=this["_"+b])&&"object"===typeof c&&!this.hasOwnProperty("_"+b))if(c instanceof Array||"[object Array]"===Object.prototype.toString.call(c))c=c.slice();else{d={};for(a in c)k.call(c,a)&&(e=c[a],d[a]=e);c=d}return c})}}(this)(b)));return d};var rb=e.things,r=function(a){var b,c;for(b in a)k.call(a,
b)&&(c=a[b],this[b]=c);this._property_modifier_handlers={};a||this.activate_method_throughout_chain("init");this.activate_method_throughout_chain("bind_events")};l(r,e.events.EventEmitter);r.cname="engine.things.Base";r.prototype.init=function(){};e.things.define_getter.call(r,"id",function(){return this._id});r.prototype.add_id=function(a){return null!=this._id?!1:this._id=a};r.prototype.activate_method_throughout_chain=function(){var a,b,c,d;b=arguments[0];a=2<=arguments.length?v.call(arguments,
1):[];c=this;for(d=[];c=Object.getPrototypeOf(c);)c.hasOwnProperty(b)&&"function"===typeof c[b]?d.push(c[b].apply(this,a)):d.push(void 0);return d};r.prototype.check_for_property_chaining=function(a){var b,c,d,f,g,h,i;h=this;for(i=[];h=Object.getPrototypeOf(h);)if(h.constructor&&(g=h.constructor.property_chains)){if(null!=g)if(c=g[a.property],null!=c){b=[];for(d=a.parent_event;null!=d;)b.push(d.property),d=d.parent_event;i.push(function(){var d,g,h;h=[];d=0;for(g=c.length;d<g;d++)f=c[d],0<=R.call(b,
f)||h.push(this.trigger(new e.events.ThingPropertyAffected(f,a)));return h}.call(this))}else i.push(void 0)}else i.push(void 0);return i};r.prototype.update_property=function(a){var b;if(this.hasOwnProperty("_"+a)&&(b=this["_"+a],delete this["_"+a],JSON.stringify(b)!==JSON.stringify(this["_"+a])))return this["_"+a]=b};r.prototype.check_for_property_modifiers=function(a,b){var c;this._property_modifier_handlers[a]&&(c="__temp_"+a+"_modifier",this[c]=b,this.trigger(new e.events.Base("property_accessed",
{property:a,value:b,property_name:c})),b=this[c],delete this[c]);return b};r.prototype.bind_property_modifier_handler=function(a,b,c){var d;d=this._property_modifier_handlers[a]||[];d.push(b);this._property_modifier_handlers[a]=d;this.on("property_accessed",b,c);return this.trigger(new e.events.ThingPropertyAffected(a))};r.prototype.unbind_property_modifier_handler=function(a,b){var c;if(c=this._property_modifier_handlers[a])e.utils.remove_val_from_array(c,b),this._property_modifier_handlers[a]=c;
this.off("property_accessed",b);return this.trigger(new e.events.ThingPropertyAffected(a))};r.prototype.bind_events=function(){this.on("property_change",function(a){return function(b){a.update_property(b.property);return a.trigger(new e.events.ThingPropertyAffected(b.property))}}(this));return this.on("property_affected",function(a){return function(b){a.trigger(new e.events.ThingSpecificPropertyAffected(b.property));return a.check_for_property_chaining(b)}}(this))};r.prototype.unbind_events=function(){return this.off()};
r.prototype.registry_available=function(a){return this.registry=a};r.prototype.get_save_data=function(){var a,b,c,d;a={};c=["_events","_property_modifier_handlers","registry"];for(b in this)k.call(this,b)&&(d=this[b],0<=R.call(c,b)||(a[b]=d));return a};r.prototype.remove=function(){return this.off()};rb.Base=r;var sb=e.things,oa=function(){return oa.__super__.constructor.apply(this,arguments)};l(oa,e.things.Base);oa.cname="engine.things.Abstract";sb.Abstract=oa;var tb=e.things,y=function(){return y.__super__.constructor.apply(this,
arguments)};l(y,e.things.Abstract);y.cname="engine.things.LightSource";e.things.define_defaults.call(y,{intensity:0,color:"ffffff"});e.things.define_getter.call(y,"has_target",function(){return null!=this._target});e.things.define_getter.call(y,"x",function(){var a;null==this._x&&(a=this.registry.get_thing(this._target),this._x=null!=a?a.x:void 0);return this._x});e.things.define_getter.call(y,"y",function(){var a;null==this._y&&(a=this.registry.get_thing(this._target),this._y=null!=a?a.y:void 0);
return this._y});e.things.define_setter.call(y,"intensity",function(a){var b;b=this._intensity;this._intensity=a;return this.trigger(new e.events.Base("light_intensity_updated",{value:a,prev_value:b}))});e.things.define_setter.call(y,"color",function(a){this._color=a;return this.trigger(new e.events.Base("light_color_updated",{value:a}))});y.prototype.registry_available=function(a){var b;b=this._target;if(null!=b)return a=a.get_thing(b),a.on("sprite_moved",this._sprite_moved,this)};y.prototype.apply=
function(a){this._x=a.x;this._y=a.y;this._target=a.id;a.add_light_source(this);a.on("sprite_moved",this._sprite_moved,this);return this.trigger(new e.events.Base("light_applied"))};y.prototype.remove=function(a){a=a||this.registry.get_thing(this._target);a.remove_light_source(this);this._target=void 0;return a.off("sprite_moved",this._sprite_moved,this)};y.prototype._sprite_moved=function(a){this._x=a.x;this._y=a.y;return this.trigger(new e.events.Base("light_position_updated",{x:a.x,y:a.y,prev_x:a.prev_x,
prev_y:a.prev_y}))};tb.LightSource=y;var ub=e.things,M=function(){return M.__super__.constructor.apply(this,arguments)};l(M,e.things.Base);M.cname="engine.things.NonAbstract";e.things.define_defaults.call(M,{x:null,y:null,z:null});e.things.define_getter.call(M,"x",function(){if(null!=this._x)return this._x;if(null!=this._owner)return this._owner.x});e.things.define_getter.call(M,"y",function(){if(null!=this._y)return this._y;if(null!=this._owner)return this._owner.y});e.things.define_getter.call(M,
"z",function(){if(null!=this._z)return this._z;if(null!=this._owner)return this._owner.z});M.prototype.change_constructor=function(a){return new a(this.get_save_data())};ub.NonAbstract=M;var vb=e.things,p=function(a){var b,c;this.things={};null!=a?this._restore(a):this._init();c=this.things;for(b in c)a=c[b],null!==a&&a.activate_method_throughout_chain("registry_available",this)};l(p,e.events.EventEmitter);p.prototype._restore_thing_from_serial_data=function(a){return this.constructor_manager.restore_object_from_data(a)};
p.prototype._prepare_thing_for_storing=function(a){return this.constructor_manager.get_save_data_from_object(a)};p.prototype._init=function(){this.id_count=0;return this.constructor_manager=new e.ConstructorManager};p.prototype._restore=function(a){var b,c,d;"string"===typeof a&&(a=JSON.parse(a));this.id_count=a.id_count;this.constructor_manager=new e.ConstructorManager(a.constructor_manager);d=a.things;for(b in d)k.call(d,b)&&(c=d[b],this.things[b]=null===c?null:this._restore_thing_from_serial_data(c));
if(null!=a.cached_things){a=a.cached_things;d=[];for(b in a)k.call(a,b)&&(c=a[b],d.push(localStorage.setItem("thing_cache_"+b,c)));return d}};p.prototype.get_id=function(){var a;a=this.id_count;this.id_count+=1;return a};p.prototype.register_thing=function(a){null!=a.id?this._replace_thing(a):this._add_thing(a);a.registry=this;a.activate_method_throughout_chain("registry_available",this);this.trigger(new e.events.Base("registered_thing",{id:a.id,thing:a}));a instanceof e.things.Brain&&this.trigger(new e.events.Base("registered_brain",
{id:a.id,thing:a}));return a.id};p.prototype._add_thing=function(a){var b;b=this.get_id();a.add_id(b);return this.things[b]=a};p.prototype._replace_thing=function(a){return this.things[a.id]=a};p.prototype.unregister_thing=function(a){delete this.things[a.id];this.trigger(new e.events.Base("unregistered_thing",{id:a.id,thing:a}));if(a instanceof e.things.Brain)return this.trigger(new e.events.Base("unregistered_brain",{id:a.id,thing:a}))};p.prototype.cache_thing=function(a){var b,c;b=this.things[a];
b.activate_method_throughout_chain("unbind_events");c=JSON.stringify(this._prepare_thing_for_storing(b));localStorage.setItem("thing_cache_"+b.id,c);this.things[b.id]=null;this.trigger(new e.events.Base("cached_thing",{id:a,thing:b}));if(b instanceof e.things.Brain)return this.trigger(new e.events.Base("cached_brain",{id:a,thing:b}))};p.prototype.remove_cached_things_from_local_storage=function(){var a,b,c,d;c=this.things;d=[];for(a in c)b=c[a],null===b?d.push(localStorage.removeItem("thing_cache_"+
a)):d.push(void 0);return d};p.prototype.uncache_thing=function(a){var b;b=this._restore_thing_from_serial_data(JSON.parse(localStorage.getItem("thing_cache_"+a)));localStorage.removeItem("thing_cache_"+a);this.things[a]=b;this.trigger(new e.events.Base("uncached_thing",{id:a,thing:b}));b instanceof e.things.Brain&&this.trigger(new e.events.Base("uncached_brain",{id:a,thing:b}));return b};p.prototype.get_thing=function(a){var b;b=this.things[a];null===b&&(b=this.uncache_thing(a));return b};p.prototype.get_things_with_position=
function(a,b){var c,d,e,g;d=[];g=this.things;c=e=0;for(g=g.length;e<g;c=++e)c.x===a&&c.y===b&&d.push(c);return c};p.prototype._get_save_data=function(){return{things:{},cached_things:{},id_count:this.id_count,constructor_manager:this.constructor_manager.get_save_data()}};p.prototype._get_quicksave_data=function(){var a,b,c,d;b=this._get_save_data();d=this.things;for(a in d)k.call(d,a)&&(c=d[a],b.things[a]=null===c?null:this._prepare_thing_for_storing(c));return b};p.prototype._get_fullsave_data=function(){var a,
b,c,d;b=this._get_save_data();d=this.things;for(a in d)k.call(d,a)&&(c=d[a],null===c?b.cached_things[a]=localStorage.getItem("thing_cache_"+a):b.things[a]=this._prepare_thing_for_storing(c));return b};p.prototype.get_save_data=function(a){return!0===a?this._get_quicksave_data():this._get_fullsave_data()};vb.Registry=p;var wb=e.things,X=function(){return X.__super__.constructor.apply(this,arguments)};l(X,e.things.Abstract);X.cname="engine.things.Effect";e.things.define_defaults.call(X,{type:null,target:null,
level:0,duration:!1});X.prototype.apply=function(a){this._target=a.id;a.add_effect(this);if(!this._duration)return this.remove(a)};X.prototype.remove=function(a){a=a||this.registry.get_thing(this._target);return a.remove_effect(this)};wb.Effect=X;var xb=e.things,Y=function(){return Y.__super__.constructor.apply(this,arguments)};l(Y,e.things.Abstract);Y.cname="engine.things.Effect";e.things.define_defaults.call(Y,{type:null,target:null,level:0,duration:!1});Y.prototype.apply=function(a){this._target=
a.id;a.add_effect(this);if(!this._duration)return this.remove(a)};Y.prototype.remove=function(a){a=a||this.registry.get_thing(this._target);return a.remove_effect(this)};xb.Effect=Y;var yb=e.things,z=function(){return z.__super__.constructor.apply(this,arguments)};l(z,e.things.Abstract);z.cname="engine.things.Condition";e.things.define_defaults.call(z,{target:null,source:null,length:0,counter:0,canceling_events:[]});z.prototype.apply=function(a,b){this._target=a.id;null!=b&&(this._source=b.id);this._on();
0===this._length&&this._off();return this._bind_events()};z.prototype.remove=function(){this._unbind_events();if(null!=this._target)return this._off()};z.prototype.registry_available=function(a){this.registry=a;return this._bind_events()};z.prototype._bind_events=function(){var a,b,c,d,e,g;if(null!=this._target){b=this.registry.get_thing(this._target);if(0<this._length)b.on("tick",this._tick_handler,this);e=this.canceling_events;g=[];c=0;for(d=e.length;c<d;c++)a=e[c],g.push(b.on(a,this.remove,this));
return g}};z.prototype._unbind_events=function(){var a,b,c,d,e,g;if(null!=this._target){b=this.registry.get_thing(this._target);b.off("tick",this._tick_handler);e=this.canceling_events;g=[];c=0;for(d=e.length;c<d;c++)a=e[c],g.push(b.off(a,this.remove));return g}};z.prototype._tick_handler=function(a){this._tick(a.time);this.counter+=a.time;if(this.counter>=this._length)return this.remove()};z.prototype._on=function(){};z.prototype._off=function(){};z.prototype._tick=function(){};yb.Condition=z;var zb=
e.things,F=function(){return F.__super__.constructor.apply(this,arguments)},Ga,Ha,pa,Ia,Aa;l(F,e.things.NonAbstract);F.cname="engine.things.Sprite";e.things.define_defaults.call(F,{owner:null,width:null,height:null,size:"medium",light_sources:[],visual_effects:[],sound_effects:[],smell_effects:[],touch_effects:[]});e.things.define_getter.call(F,"width",function(){return null!=this._width?this._width:1});e.things.define_getter.call(F,"height",function(){return null!=this._height?this._height:1});Aa=
["visual","sound","smell","touch"];Ha=function(a){return e.things.define_getter.call(F,""+a+"_effects_level",function(){var b,c,d,e,g;c=0;g=this[""+a+"_effects"];d=0;for(e=g.length;d<e;d++)b=g[d],(b=this.registry.get_thing(b))&&(c=Math.max(c,b.level));return c})};pa=0;for(Ia=Aa.length;pa<Ia;pa++)Ga=Aa[pa],Ha(Ga);F.prototype.move_to=function(a,b,c){var d,f,g;d=this.x;f=this.y;g=this.z;this.x=a;this.y=b;null!=c&&(this.z=c);null==c&&(c=this.z);return this.trigger(new e.events.SpriteMoved(a,b,c,d,f,g))};
F.prototype.add_effect=function(a){var b;if(b=this[""+a.type+"_effects"])return b.push(a.id),this[""+a.type+"_effects"]=b};F.prototype.remove_effect=function(a){var b;if(b=this[""+a.type+"_effects"])return e.utils.remove_val_from_array(b,a.id),this[""+a.type+"_effects"]=b};F.prototype.add_light_source=function(a){var b;b=this.light_sources;b.push(a.id);return this.light_sources=b};F.prototype.remove_light_source=function(a){var b;b=this.light_sources;e.utils.remove_val_from_array(b,a.id);return this.light_sources=
b};zb.Sprite=F;var Ab=e.things,ba=function(){return ba.__super__.constructor.apply(this,arguments)};l(ba,e.things.Sprite);ba.cname="engine.things.Sentient";e.things.define_defaults.call(ba,{brain:null});ba.prototype.give_sentience=function(a){this.brain=a.id;a.set_host(this.id)};Ab.Sentient=ba;var Bb=e.things,N=function(){return N.__super__.constructor.apply(this,arguments)};l(N,e.things.Base);N.cname="engine.things.Brain";e.things.define_defaults.call(N,{host:null,senses:{sight:10,smell:0,hearing:0,
touch:1}});N.prototype.take_turn=function(a){return this.do_action(function(b){return function(c){b.trigger(new e.events.Base("tick",{time:c}));return a(c)}}(this))};N.prototype.do_action=function(a){return a(0)};N.prototype.set_host=function(a){return this.host=a};N.prototype.get_host=function(){return this.registry.get_thing(this.host)};Bb.Brain=N;var Cb=e.things,ha=function(){return ha.__super__.constructor.apply(this,arguments)};l(ha,e.things.Brain);ha.cname="engine.things.Player";ha.prototype.do_action=
function(a){this.offerred_turn_handler();return this.listen_for_actions_handler(a,function(b){return function(c){console.log("Error completing action:",c);return b.do_action(a)}}(this))};Cb.Player=ha;var Db=e.things,qa=function(){return qa.__super__.constructor.apply(this,arguments)};l(qa,e.things.Brain);qa.cname="engine.things.NonPlayer";Db.NonPlayer=qa;e.config={application_class:"engine.Application",game_class:"engine.Game",chargen_class:"engine.CharacterGenerator",base_player_thing_class:"engine.things.Sentient",
player_character_class:"engine.things.Player",thing_registry_class:"engine.things.Registry",timekeeper_class:"engine.TimeKeeper",user_settings:{},geography:{zone_manager_class:"engine.geography.ZoneManager",zone_size:64,loading_buffer:64},ui:{tile_map:{tile_width:20,tile_height:20,view_width:24,view_height:16}}};e.boot_game=function(a){var b;b={};e.utils.deep_extend(b,e.config,a.config);return(new (e.utils.constructor_from_string(b.application_class))(b)).start()};if("function"===typeof define&&define.amd)define([],
function(){return e});else if("undefined"!==typeof exports&&null!==exports)for(ra in e)Ba=e[ra],exports[ra]=Ba;else window.engine=e}).call(this);
